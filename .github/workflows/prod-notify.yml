name: prod-push-notify

on:
  push:
    branches: [ "prod" ]

jobs:
  notify-and-maybe-trigger:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Mark start
        id: start
        run: echo "ts=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Extract info
        id: info
        run: |
          echo "commit_msg<<EOF" >> $GITHUB_OUTPUT
          echo "${{ github.event.head_commit.message }}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "sha=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ap-northeast-2
          role-to-assume: ${{ github.ref_name == 'prod' && secrets.AWS_ROLE_ARN_PROD || secrets.AWS_ROLE_ARN_DEV }}

      - name: Send Slack interactive message
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ vars.SLACK_CHANNEL_ID }}
          POKEMON_IMG_URL: "https://img1.daumcdn.net/thumb/R1280x0.fjpg/?fname=http://t1.daumcdn.net/brunch/service/user/gIN8/image/Bbg6YmZxj5wbt4Nwiaj43bJSwT4.jpg"
        run: |
          set -euo pipefail

          COMMIT="${{ steps.info.outputs.sha }}"
          MSG="${{ steps.info.outputs.commit_msg }}"
          REPO="${{ github.repository }}"
          RUN_ID="${{ github.run_id }}"
          RUN_NUMBER="${{ github.run_number }}"

          # auto ì—¬ë¶€ ê°ì§€ (ëŒ€ì†Œë¬¸ìž ë¬´ì‹œ)
          if echo "$MSG" | grep -iq 'deploy: auto'; then
            AUTO=true
          else
            AUTO=false
          fi

          # ë²„íŠ¼ valueì— ì»¨í…ìŠ¤íŠ¸(JSON) ë‹´ê¸°
          VAL_CANARY=$(jq -cn \
            --arg repo "$REPO" \
            --arg run_id "$RUN_ID" \
            --arg sha "$COMMIT" \
            --arg env "prod" \
            '{repo:$repo,run_id:$run_id,sha:$sha,env:$env}')

          VAL_BG=$(jq -cn \
            --arg repo "$REPO" \
            --arg run_id "$RUN_ID" \
            --arg sha "$COMMIT" \
            --arg env "prod" \
            '{repo:$repo,run_id:$run_id,sha:$sha,env:$env}')

          # Slack blocks ì¡°ë¦½
          BODY=$(jq -cn \
          --arg channel "$SLACK_CHANNEL_ID" \
          --arg commit "$COMMIT" \
          --arg msg "$MSG" \
          --arg runnum "$RUN_NUMBER" \
          --arg val_canary "$VAL_CANARY" \
          --arg val_bg "$VAL_BG" \
          --arg img "$POKEMON_IMG_URL" \
          --arg text_fallback "prod deploy" \
          --arg title "ðŸš€ PROD ë°°í¬ ì¤€ë¹„ ì™„ë£Œ" \
          --arg subtitle "ë²„íŠ¼ì„ ëˆŒëŸ¬ CodePipelineì„ ì‹œìž‘í•˜ì„¸ìš”" \
          --arg cta_canary "Deploy (Skip Test)" \
          --arg cta_bg "Deploy" \
          --argjson auto "$AUTO" \
          '
          def header_block(t): {type:"header", text:{type:"plain_text", text:t, emoji:true}};
          def hero_img(u): {type:"image", image_url:u, alt_text:"hero"};
          def info_section(commit; msg; runnum):
            {type:"section",
             text:{type:"mrkdwn",
               text: ("*prod* push: `\(commit)`\n\(msg)\nRun #\(runnum)")}};
          def subtitle_block(s): {type:"context", elements:[{type:"mrkdwn", text:s}]};
          def actions_block(val_canary; cta_canary; val_bg; cta_bg):
            {type:"actions", block_id:"deploy_panel", elements:[
              {type:"button", action_id:"deploy_prod_canary",
               text:{type:"plain_text", text:cta_canary},
               style:"primary",
               value:val_canary},
              {type:"button", action_id:"deploy_prod_bg",
               text:{type:"plain_text", text:cta_bg},
               style:"danger",
               value:val_bg}
            ]};
          def dashboard_block:
          {type:"actions", block_id:"dashboard_panel", elements:[
            {type:"button",
              text:{type:"plain_text", text:"Go to Dashboard"},
              style:"primary",
              url:"https://d17voj2j3ddvzy.cloudfront.net"}
          ]};


          {
            channel: $channel,
            text: $text_fallback,
            blocks: (
              [
                header_block($title),
                hero_img($img),
                info_section($commit; $msg; $runnum),
                subtitle_block($subtitle)
              ]
              + (if $auto then [ dashboard_block ] else [ actions_block($val_canary; $cta_canary; $val_bg; $cta_bg) ] end)
            )
          }')

          RESP=$(curl -sS -X POST "https://slack.com/api/chat.postMessage" \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-type: application/json; charset=utf-8" \
            --data "$BODY")

          echo "$RESP" | jq .

          if [ "$(echo "$RESP" | jq -r '.ok')" != "true" ]; then
            echo "Slack API error: $(echo "$RESP" | jq -r '.error // "unknown_error"')" >&2
            exit 1
          fi




      - name: Publish CI metrics to CloudWatch
        if: always()
        env:
          NS: CI/GitHub
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          WORKFLOW: ${{ github.workflow }}
        run: |
          DURATION=$(( $(date +%s) - ${{ steps.start.outputs.ts }} ))
          STATUS_VAL=0
          if [ "${{ job.status }}" = "success" ]; then STATUS_VAL=1; fi

          DIM="repo=$REPO,branch=$BRANCH,workflow=$WORKFLOW"

          aws cloudwatch put-metric-data \
            --namespace "$NS" \
            --metric-name BuildStatus \
            --value "$STATUS_VAL" \
            --unit Count \
            --dimensions "$DIM"

          aws cloudwatch put-metric-data \
            --namespace "$NS" \
            --metric-name BuildDurationSec \
            --value "$DURATION" \
            --unit Seconds \
            --dimensions "$DIM"

          aws cloudwatch put-dashboard \
            --region ap-northeast-2 \
            --dashboard-name CI-Observability \
            --dashboard-body "$(
              jq -nc \
                --arg repo "$REPO" \
                --arg branch "$BRANCH" \
                --arg workflow "$WORKFLOW" \
                '{
                  widgets: [
                    {
                      type: "metric",
                      x: 0, y: 0, width: 12, height: 6,
                      properties: {
                        title: "CI Success Rate (avg of BuildStatus)",
                        region: "ap-northeast-2",
                        stat: "Average",
                        period: 60,
                        yAxis: { left: { min: 0, max: 1 } },
                        metrics: [[
                          "CI/GitHub", "BuildStatus",
                          "repo", $repo,
                          "branch", $branch,
                          "workflow", $workflow
                        ]],
                        view: "timeSeries",
                        legend: { position: "right" }
                      }
                    },
                    {
                      type: "metric",
                      x: 12, y: 0, width: 12, height: 6,
                      properties: {
                        title: "Build Duration (p95, sec)",
                        region: "ap-northeast-2",
                        stat: "p95",
                        period: 60,
                        metrics: [[
                          "CI/GitHub", "BuildDurationSec",
                          "repo", $repo,
                          "branch", $branch,
                          "workflow", $workflow
                        ]],
                        view: "timeSeries"
                      }
                    }
                  ]
                }'
            )"

