name: prod-push-notify

on:
  push:
    branches: [ "prod" ]

jobs:
  notify-and-maybe-trigger:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Mark start
        id: start
        run: echo "ts=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Extract info
        id: info
        run: |
          echo "commit_msg<<EOF" >> $GITHUB_OUTPUT
          echo "${{ github.event.head_commit.message }}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "sha=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ap-northeast-2
          role-to-assume: ${{ github.ref_name == 'prod' && secrets.AWS_ROLE_ARN_PROD || secrets.AWS_ROLE_ARN_DEV }}

      - name: Send Slack message
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          COMMIT="${{ steps.info.outputs.sha }}"
          MSG="${{ steps.info.outputs.commit_msg }}"
          PAYLOAD=$(jq -n --arg text "*prod* push: \`$COMMIT\`\n$MSG" \
             '{text:$text}')
          curl -X POST -H 'Content-type: application/json' \
               --data "$PAYLOAD" "$SLACK_WEBHOOK_URL"

      # - name: Auto trigger if keyword present
      #   if: contains(steps.info.outputs.commit_msg, '[auto-deploy]')
      #   run: |
      #     aws lambda invoke \
      #       --function-name softbank-prod-trigger \
      #       --payload "$(jq -n --arg commit "${{ steps.info.outputs.sha }}" \
      #                        '{source:"github", auto:true, commit:$commit}')" \
      #       /dev/null


      - name: Send Slack interactive message
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}   # xoxb-***
          SLACK_CHANNEL_ID: ${{ vars.SLACK_CHANNEL_ID }}     # C0123ABCDEF
        run: |
          COMMIT="${{ steps.info.outputs.sha }}"
          MSG="${{ steps.info.outputs.commit_msg }}"
          REPO="${{ github.repository }}"
          RUN_ID="${{ github.run_id }}"
          RUN_NUMBER="${{ github.run_number }}"

          # Î≤ÑÌäº valueÏóê Ïª®ÌÖçÏä§Ìä∏Î•º JSONÏúºÎ°ú Îã¥Í∏∞
          VAL_PROD=$(jq -cn --arg repo "$REPO" --arg run_id "$RUN_ID" --arg sha "$COMMIT" --arg env "prod" --arg strategy "canary" \
            '{repo:$repo,run_id:$run_id,sha:$sha,env:$env,strategy:$strategy}')

          read -r -d '' BLOCKS << 'JSON'
          [
            { "type":"section",
              "text":{"type":"mrkdwn","text":"*prod* push: `${COMMIT}`\n${MSG}\nRun #${RUN_NUMBER}"} },
            { "type":"actions","block_id":"deploy_panel",
              "elements":[
                { "type":"button","action_id":"deploy_prod",
                  "text":{"type":"plain_text","text":"üöÄ Deploy PROD"},
                  "style":"danger",
                  "value":"__VAL_PROD__" }
              ] }
          ]
          JSON

          BLOCKS="${BLOCKS//\${COMMIT}/$COMMIT}"
          BLOCKS="${BLOCKS//\${MSG}/$(printf '%s' "$MSG" | sed 's/"/\\"/g')}"
          BLOCKS="${BLOCKS//\${RUN_NUMBER}/$RUN_NUMBER}"
          BLOCKS="${BLOCKS/__VAL_PROD__/$VAL_PROD}"

          curl -sS -X POST https://slack.com/api/chat.postMessage \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H 'Content-type: application/json; charset=utf-8' \
            --data "$(jq -n --arg channel "$SLACK_CHANNEL_ID" --argjson blocks "$BLOCKS" '{channel:$channel, blocks:$blocks, text:"prod deploy"}')"


      - name: Publish CI metrics to CloudWatch
        if: always()
        env:
          NS: CI/GitHub
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          WORKFLOW: ${{ github.workflow }}
        run: |
          DURATION=$(( $(date +%s) - ${{ steps.start.outputs.ts }} ))
          STATUS_VAL=0
          if [ "${{ job.status }}" = "success" ]; then STATUS_VAL=1; fi

          DIM="repo=$REPO,branch=$BRANCH,workflow=$WORKFLOW"

          aws cloudwatch put-metric-data \
            --namespace "$NS" \
            --metric-name BuildStatus \
            --value "$STATUS_VAL" \
            --unit Count \
            --dimensions "$DIM"

          aws cloudwatch put-metric-data \
            --namespace "$NS" \
            --metric-name BuildDurationSec \
            --value "$DURATION" \
            --unit Seconds \
            --dimensions "$DIM"

          aws cloudwatch put-dashboard \
            --region ap-northeast-2 \
            --dashboard-name CI-Observability \
            --dashboard-body "$(
              jq -nc \
                --arg repo "$REPO" \
                --arg branch "$BRANCH" \
                --arg workflow "$WORKFLOW" \
                '{
                  widgets: [
                    {
                      type: "metric",
                      x: 0, y: 0, width: 12, height: 6,
                      properties: {
                        title: "CI Success Rate (avg of BuildStatus)",
                        region: "ap-northeast-2",
                        stat: "Average",
                        period: 60,
                        yAxis: { left: { min: 0, max: 1 } },
                        metrics: [[
                          "CI/GitHub", "BuildStatus",
                          "repo", $repo,
                          "branch", $branch,
                          "workflow", $workflow
                        ]],
                        view: "timeSeries",
                        legend: { position: "right" }
                      }
                    },
                    {
                      type: "metric",
                      x: 12, y: 0, width: 12, height: 6,
                      properties: {
                        title: "Build Duration (p95, sec)",
                        region: "ap-northeast-2",
                        stat: "p95",
                        period: 60,
                        metrics: [[
                          "CI/GitHub", "BuildDurationSec",
                          "repo", $repo,
                          "branch", $branch,
                          "workflow", $workflow
                        ]],
                        view: "timeSeries"
                      }
                    }
                  ]
                }'
            )"
